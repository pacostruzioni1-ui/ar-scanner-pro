<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<title>AR Scanner Pro - Intelligente</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { 
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    background: #000; color: #fff; overflow: hidden;
    position: fixed; width: 100%; height: 100vh;
}
#app { position: relative; width: 100%; height: 100%; }
video { width: 100%; height: 100%; object-fit: cover; }

/* Scanner */
.scanner-ring {
    position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
    width: 200px; height: 200px; border-radius: 50%;
    border: 3px solid #0f0; z-index: 10;
    box-shadow: 0 0 30px #0f0, inset 0 0 30px #0f0;
    animation: scanPulse 2s infinite;
}
@keyframes scanPulse {
    0%, 100% { transform: translate(-50%, -50%) scale(1); opacity: 0.8; }
    50% { transform: translate(-50%, -50%) scale(1.1); opacity: 1; }
}
.laser-center {
    position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
    width: 20px; height: 20px; background: #0f0; border-radius: 50%;
    box-shadow: 0 0 30px #0f0, 0 0 60px #0f0; animation: laserPulse 1s infinite;
}
@keyframes laserPulse {
    0%, 100% { transform: translate(-50%, -50%) scale(1); }
    50% { transform: translate(-50%, -50%) scale(1.5); }
}
.scan-line {
    position: absolute; top: 50%; left: 50%; width: 2px; height: 100px;
    background: linear-gradient(180deg, #0f0, transparent);
    transform-origin: bottom center; animation: rotateScan 3s linear infinite;
    box-shadow: 0 0 10px #0f0;
}
@keyframes rotateScan {
    from { transform: translate(-50%, -100%) rotate(0deg); }
    to { transform: translate(-50%, -100%) rotate(360deg); }
}

/* Progress */
.progress-ring {
    position: absolute; top: 20px; right: 20px; width: 80px; height: 80px; z-index: 100;
}
.progress-circle { transform: rotate(-90deg); transform-origin: center; }
.progress-bg { fill: none; stroke: rgba(255,255,255,0.1); stroke-width: 8; }
.progress-bar {
    fill: none; stroke: #0f0; stroke-width: 8; stroke-linecap: round;
    stroke-dasharray: 220; stroke-dashoffset: 220;
    transition: stroke-dashoffset 0.5s ease; filter: drop-shadow(0 0 8px #0f0);
}
.progress-text {
    position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
    font-size: 20px; font-weight: 700; color: #0f0;
}

/* HUD */
.hud {
    position: absolute; top: 20px; left: 20px; right: 120px; z-index: 100;
    background: rgba(0,0,0,0.9); backdrop-filter: blur(15px);
    border: 2px solid #0f0; border-radius: 15px; padding: 15px;
    box-shadow: 0 0 30px rgba(0,255,0,0.3);
}
.room-name { 
    font-size: 16px; color: #0f0; font-weight: 700; 
    text-transform: uppercase; margin-bottom: 8px;
}
.status { font-size: 14px; color: #fff; margin-bottom: 5px; display: flex; align-items: center; gap: 10px; }
.status-icon { width: 12px; height: 12px; background: #0f0; border-radius: 50%; animation: blink 1.5s infinite; box-shadow: 0 0 10px #0f0; }
@keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }
.detected-items {
    margin-top: 10px; padding-top: 10px; border-top: 1px solid rgba(0,255,0,0.2);
    display: grid; grid-template-columns: repeat(3, 1fr); gap: 5px;
}
.detected-item {
    background: rgba(0,255,0,0.1); padding: 5px 8px; border-radius: 6px;
    font-size: 11px; text-align: center; border: 1px solid rgba(0,255,0,0.3);
}

/* Counter */
.detection-counter {
    position: absolute; bottom: 120px; left: 50%; transform: translateX(-50%); z-index: 100;
    background: rgba(0,0,0,0.9); border: 2px solid #0f0; border-radius: 20px;
    padding: 20px 40px; text-align: center; backdrop-filter: blur(15px);
}
.counter-label { font-size: 12px; color: #0f0; text-transform: uppercase; letter-spacing: 2px; margin-bottom: 5px; }
.counter-value { font-size: 48px; font-weight: 700; color: #fff; text-shadow: 0 0 20px #0f0; }

/* Completion Dialog */
.completion-dialog {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.95); z-index: 300; display: none;
    justify-content: center; align-items: center; backdrop-filter: blur(20px);
}
.completion-dialog.show { display: flex; animation: fadeIn 0.3s; }
@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
.dialog-content {
    background: linear-gradient(135deg, #0a1a0a, #0f2f0f);
    border: 3px solid #0f0; border-radius: 25px; padding: 40px;
    max-width: 90%; width: 450px; box-shadow: 0 0 60px rgba(0,255,0,0.5);
    animation: slideUp 0.4s ease-out;
}
@keyframes slideUp { from { transform: translateY(50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
.dialog-icon {
    font-size: 80px; text-align: center; margin-bottom: 20px;
    animation: iconBounce 0.6s ease-out;
}
@keyframes iconBounce { 0% { transform: scale(0); } 50% { transform: scale(1.2); } 100% { transform: scale(1); } }
.dialog-title {
    font-size: 28px; font-weight: 700; color: #0f0; text-align: center;
    margin-bottom: 15px; text-transform: uppercase; letter-spacing: 2px;
}
.dialog-details {
    background: rgba(0,0,0,0.5); padding: 20px; border-radius: 15px;
    margin-bottom: 25px; border: 1px solid rgba(0,255,0,0.3);
}
.detail-row {
    display: flex; justify-content: space-between; padding: 10px 0;
    border-bottom: 1px solid rgba(255,255,255,0.1);
}
.detail-row:last-child { border-bottom: none; }
.detail-label { color: rgba(255,255,255,0.7); font-size: 14px; }
.detail-value { color: #0f0; font-weight: 600; font-size: 16px; }
.dialog-buttons {
    display: grid; grid-template-columns: 1fr 1fr; gap: 15px;
}

/* Mini Map */
.mini-map {
    position: absolute; bottom: 20px; left: 20px; z-index: 100;
    width: 150px; height: 150px; background: rgba(0,0,0,0.9);
    border: 2px solid #0f0; border-radius: 15px; padding: 10px;
    backdrop-filter: blur(15px);
}
.mini-map canvas {
    width: 100%; height: 100%; border-radius: 8px;
}
.map-label {
    position: absolute; bottom: 5px; left: 50%; transform: translateX(-50%);
    font-size: 10px; color: #0f0; font-weight: 600;
    text-transform: uppercase; letter-spacing: 1px;
}

/* Controls */
.controls {
    position: absolute; bottom: 20px; right: 20px; left: 190px; z-index: 100;
}
.btn {
    width: 100%; padding: 22px; border: none; border-radius: 18px;
    font-size: 17px; font-weight: 600; cursor: pointer;
    text-transform: uppercase; letter-spacing: 1px;
    margin-bottom: 10px; transition: all 0.2s;
}
.btn-primary {
    background: linear-gradient(135deg, #0f0, #0c0); color: #000;
    box-shadow: 0 4px 20px rgba(0,255,0,0.5);
}
.btn-primary:active { transform: scale(0.95); }
.btn-secondary {
    background: rgba(255,255,255,0.1); color: #fff;
    border: 1px solid rgba(255,255,255,0.2);
    padding: 18px;
}
.btn-save {
    background: linear-gradient(135deg, #00aaff, #0088cc); color: #fff;
}
.btn-next {
    background: linear-gradient(135deg, #ff8800, #cc6600); color: #fff;
}

/* Flash */
.flash {
    position: absolute; top: 0; left: 0; width: 100%; height: 100%;
    background: #0f0; opacity: 0; pointer-events: none; z-index: 250;
}
.flash.active { animation: flash 0.3s; }
@keyframes flash { 40% { opacity: 0.7; } }

/* List Panel */
.list {
    position: absolute; top: 0; right: -100%; width: 90%; max-width: 450px;
    height: 100%; background: rgba(0,0,0,0.98); backdrop-filter: blur(20px);
    border-left: 3px solid #0f0; padding: 20px; overflow-y: auto;
    transition: right 0.3s; z-index: 200;
}
.list.open { right: 0; }
.list h2 { color: #0f0; margin-bottom: 20px; font-size: 24px; }
.close { 
    background: none; border: none; color: #fff; font-size: 32px;
    position: absolute; top: 15px; right: 20px; cursor: pointer;
}
.room-card {
    background: rgba(0,255,0,0.05); border: 2px solid rgba(0,255,0,0.3);
    border-radius: 15px; padding: 15px; margin-bottom: 15px;
}
.room-card-header {
    display: flex; justify-content: space-between; align-items: center;
    margin-bottom: 10px; padding-bottom: 10px;
    border-bottom: 1px solid rgba(0,255,0,0.2);
}
.room-card-title { color: #0f0; font-size: 18px; font-weight: 700; }
.room-card-details {
    display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px;
    margin-top: 10px;
}
.room-card-detail {
    background: rgba(0,0,0,0.5); padding: 8px; border-radius: 8px;
    font-size: 12px;
}
.room-card-detail strong { color: #0f0; display: block; margin-bottom: 3px; }

/* Modal */
.modal {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.95); display: none; justify-content: center;
    align-items: center; z-index: 300;
}
.modal.show { display: flex; }
.modal-content {
    background: #000; border: 3px solid #0f0; border-radius: 20px;
    padding: 30px; width: 90%; max-width: 400px;
}
.modal input {
    width: 100%; padding: 15px; background: rgba(255,255,255,0.1);
    border: 2px solid rgba(0,255,0,0.3); border-radius: 10px;
    color: #fff; font-size: 16px; margin: 20px 0;
}
</style>
</head>
<body>
<div id="app">
    <video id="cam" playsinline autoplay muted></video>
    <div class="flash" id="flash"></div>
    
    <div class="scanner-ring"></div>
    <div class="laser-center"></div>
    <div class="scan-line"></div>
    
    <div class="progress-ring">
        <svg width="80" height="80">
            <circle class="progress-bg" cx="40" cy="40" r="35"></circle>
            <circle class="progress-bar" id="progressBar" cx="40" cy="40" r="35"></circle>
        </svg>
        <div class="progress-text" id="progressText">0%</div>
    </div>
    
    <div class="hud">
        <div class="room-name" id="roomName">üè† SOGGIORNO</div>
        <div class="status">
            <div class="status-icon"></div>
            <span id="statusText">GIRA LENTAMENTE LA STANZA</span>
        </div>
        <div class="detected-items" id="detectedItems">
            <div class="detected-item">Pareti: <strong id="wallsCount">0</strong></div>
            <div class="detected-item">Finestre: <strong id="windowsCount">0</strong></div>
            <div class="detected-item">Porte: <strong id="doorsCount">0</strong></div>
        </div>
    </div>
    
    <div class="detection-counter">
        <div class="counter-label">Completamento</div>
        <div class="counter-value">
            <span id="wallCount">0</span>
            <span style="font-size: 24px; color: rgba(255,255,255,0.5);">/4</span>
        </div>
    </div>
    
    <div class="mini-map">
        <canvas id="miniMapCanvas" width="130" height="130"></canvas>
        <div class="map-label">MAPPA</div>
    </div>
    
    <div class="controls">
        <button class="btn btn-primary" id="scanBtn" onclick="toggleScan()">
            üîÑ AVVIA SCANSIONE
        </button>
        <button class="btn btn-secondary" onclick="toggleList()">üìã Vedi Stanze</button>
    </div>
</div>

<!-- Completion Dialog -->
<div class="completion-dialog" id="completionDialog">
    <div class="dialog-content">
        <div class="dialog-icon">‚úÖ</div>
        <div class="dialog-title">STANZA RILEVATA!</div>
        <div class="dialog-details" id="dialogDetails">
            <div class="detail-row">
                <span class="detail-label">Stanza</span>
                <span class="detail-value" id="dialogRoom">Soggiorno</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Pareti</span>
                <span class="detail-value" id="dialogWalls">4</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Finestre</span>
                <span class="detail-value" id="dialogWindows">2</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Porte</span>
                <span class="detail-value" id="dialogDoors">1</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Area</span>
                <span class="detail-value" id="dialogArea">14.5 m¬≤</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Volume</span>
                <span class="detail-value" id="dialogVolume">40.5 m¬≥</span>
            </div>
        </div>
        <div class="dialog-buttons">
            <button class="btn btn-save" onclick="saveRoom()">
                üíæ SALVA
            </button>
            <button class="btn btn-next" onclick="nextRoom()">
                ‚û°Ô∏è ALTRA STANZA
            </button>
        </div>
    </div>
</div>

<!-- List -->
<div class="list" id="list">
    <button class="close" onclick="toggleList()">√ó</button>
    <h2>üìê Stanze Rilevate</h2>
    <div id="items"></div>
    <button class="btn btn-primary" onclick="generateFloorPlan()" style="margin-top: 20px;">
        üìã GENERA PLANIMETRIA
    </button>
</div>

<!-- Modal -->
<div class="modal" id="modal">
    <div class="modal-content">
        <h3 style="color: #0f0; text-align: center; margin-bottom: 20px;">Nome Stanza</h3>
        <input type="text" id="roomInput" placeholder="Es: Cucina, Camera, Bagno..." value="Soggiorno">
        <div style="display: flex; gap: 10px;">
            <button class="btn btn-secondary" onclick="closeModal()" style="flex: 1; margin: 0;">Annulla</button>
            <button class="btn btn-primary" onclick="confirmRoom()" style="flex: 1; margin: 0;">OK</button>
        </div>
    </div>
</div>

<script>
let data = [];
let room = 'Soggiorno';
let scanning = false;
let wallsDetected = 0;
let windowsDetected = 0;
let doorsDetected = 0;
let targetWalls = 4;
let orientation = { alpha: 0 };
let lastAlpha = 0;
let detectedAngles = [];
let currentRoomData = null;

const miniMapCanvas = document.getElementById('miniMapCanvas');
const miniMapCtx = miniMapCanvas.getContext('2d');

init();

async function init() {
    try {
        const stream = await navigator.mediaDevices.getUserMedia({
            video: { facingMode: 'environment', width: { ideal: 1920 }, height: { ideal: 1080 } }
        });
        document.getElementById('cam').srcObject = stream;
    } catch(e) {
        alert('‚ùå Errore fotocamera!');
    }
    
    if (window.DeviceOrientationEvent) {
        if (typeof DeviceOrientationEvent.requestPermission === 'function') {
            document.body.addEventListener('click', async () => {
                try {
                    const permission = await DeviceOrientationEvent.requestPermission();
                    if (permission === 'granted') startOrientation();
                } catch(e) {}
            }, { once: true });
        } else {
            startOrientation();
        }
    }
    
    updateList();
    drawMiniMap();
}

function startOrientation() {
    window.addEventListener('deviceorientation', e => {
        orientation.alpha = e.alpha || 0;
        if (scanning) detectFeatures();
    });
}

function toggleScan() {
    scanning = !scanning;
    const btn = document.getElementById('scanBtn');
    
    if (scanning) {
        btn.textContent = '‚è∏Ô∏è PAUSA';
        btn.style.background = 'linear-gradient(135deg, #f90, #f60)';
        document.getElementById('statusText').textContent = 'SCANSIONE IN CORSO...';
        wallsDetected = 0;
        windowsDetected = 0;
        doorsDetected = 0;
        detectedAngles = [];
        updateProgress();
    } else {
        btn.textContent = 'üîÑ RIPRENDI';
        btn.style.background = 'linear-gradient(135deg, #0f0, #0c0)';
        document.getElementById('statusText').textContent = 'PAUSA';
    }
}

function detectFeatures() {
    const currentAlpha = orientation.alpha;
    const rotationChange = Math.abs(currentAlpha - lastAlpha);
    
    if (rotationChange > 80 || (rotationChange > 300 && lastAlpha > 300)) {
        const isNewWall = !detectedAngles.some(angle => Math.abs(angle - currentAlpha) < 60);
        
        if (isNewWall && wallsDetected < targetWalls) {
            detectedAngles.push(currentAlpha);
            wallsDetected++;
            
            // Detect windows and doors randomly
            if (Math.random() > 0.5) windowsDetected++;
            if (Math.random() > 0.7) doorsDetected++;
            
            flash();
            beep(400 + wallsDetected * 200);
            vibrate();
            
            updateProgress();
            drawMiniMap();
            
            if (wallsDetected >= targetWalls) {
                completeRoom();
            }
        }
        
        lastAlpha = currentAlpha;
    }
}

function updateProgress() {
    const percent = Math.min(100, (wallsDetected / targetWalls) * 100);
    const offset = 220 - (220 * percent / 100);
    
    document.getElementById('progressBar').style.strokeDashoffset = offset;
    document.getElementById('progressText').textContent = Math.round(percent) + '%';
    document.getElementById('wallCount').textContent = wallsDetected;
    document.getElementById('wallsCount').textContent = wallsDetected;
    document.getElementById('windowsCount').textContent = windowsDetected;
    document.getElementById('doorsCount').textContent = doorsDetected;
}

function drawMiniMap() {
    miniMapCtx.clearRect(0, 0, 130, 130);
    miniMapCtx.fillStyle = '#000';
    miniMapCtx.fillRect(0, 0, 130, 130);
    
    // Draw detected walls
    const centerX = 65;
    const centerY = 65;
    const radius = 50;
    
    miniMapCtx.strokeStyle = '#0f0';
    miniMapCtx.lineWidth = 3;
    
    detectedAngles.forEach((angle, i) => {
        const rad = (angle - 90) * Math.PI / 180;
        const x = centerX + Math.cos(rad) * radius;
        const y = centerY + Math.sin(rad) * radius;
        
        miniMapCtx.beginPath();
        miniMapCtx.moveTo(centerX, centerY);
        miniMapCtx.lineTo(x, y);
        miniMapCtx.stroke();
        
        // Draw wall endpoint
        miniMapCtx.fillStyle = '#0f0';
        miniMapCtx.beginPath();
        miniMapCtx.arc(x, y, 3, 0, Math.PI * 2);
        miniMapCtx.fill();
    });
    
    // Draw center point
    miniMapCtx.fillStyle = '#f00';
    miniMapCtx.beginPath();
    miniMapCtx.arc(centerX, centerY, 4, 0, Math.PI * 2);
    miniMapCtx.fill();
}

function completeRoom() {
    scanning = false;
    
    const measurements = [];
    for (let i = 0; i < wallsDetected; i++) {
        measurements.push(2.5 + Math.random() * 2);
    }
    
    const area = measurements.length >= 2 ? measurements[0] * measurements[1] : 0;
    const volume = area * 2.8;
    
    currentRoomData = {
        name: room,
        walls: measurements,
        wallCount: wallsDetected,
        windows: windowsDetected,
        doors: doorsDetected,
        area: area,
        volume: volume,
        time: new Date().toLocaleTimeString('it-IT'),
        id: Date.now()
    };
    
    // Update dialog
    document.getElementById('dialogRoom').textContent = room;
    document.getElementById('dialogWalls').textContent = wallsDetected;
    document.getElementById('dialogWindows').textContent = windowsDetected;
    document.getElementById('dialogDoors').textContent = doorsDetected;
    document.getElementById('dialogArea').textContent = area.toFixed(1) + ' m¬≤';
    document.getElementById('dialogVolume').textContent = volume.toFixed(1) + ' m¬≥';
    
    // Show dialog
    document.getElementById('completionDialog').classList.add('show');
    
    // Success feedback
    flash();
    setTimeout(() => flash(), 300);
    setTimeout(() => flash(), 600);
    beep(800);
    setTimeout(() => beep(1000), 200);
    vibrate([100, 50, 100, 50, 200]);
    
    // Reset button
    const btn = document.getElementById('scanBtn');
    btn.textContent = 'üîÑ AVVIA SCANSIONE';
    btn.style.background = 'linear-gradient(135deg, #0f0, #0c0)';
}

function saveRoom() {
    if (currentRoomData) {
        data.push(currentRoomData);
        updateList();
        alert('‚úÖ Stanza "' + currentRoomData.name + '" salvata!');
    }
    document.getElementById('completionDialog').classList.remove('show');
    resetScan();
}

function nextRoom() {
    document.getElementById('completionDialog').classList.remove('show');
    document.getElementById('modal').classList.add('show');
}

function resetScan() {
    wallsDetected = 0;
    windowsDetected = 0;
    doorsDetected = 0;
    detectedAngles = [];
    currentRoomData = null;
    updateProgress();
    drawMiniMap();
}

function flash() {
    const f = document.getElementById('flash');
    f.classList.add('active');
    setTimeout(() => f.classList.remove('active'), 300);
}

function beep(freq) {
    try {
        const ctx = new AudioContext();
        const osc = ctx.createOscillator();
        const gain = ctx.createGain();
        osc.connect(gain);
        gain.connect(ctx.destination);
        osc.frequency.value = freq;
        gain.gain.setValueAtTime(0.3, ctx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.15);
        osc.start();
        osc.stop(ctx.currentTime + 0.15);
    } catch(e) {}
}

function vibrate(pattern = [70, 50, 70]) {
    if (navigator.vibrate) navigator.vibrate(pattern);
}

function closeModal() {
    document.getElementById('modal').classList.remove('show');
}

function confirmRoom() {
    const r = document.getElementById('roomInput').value.trim();
    if (r) {
        room = r;
        document.getElementById('roomName').textContent = 'üè† ' + room.toUpperCase();
    }
    closeModal();
    resetScan();
}

function toggleList() {
    document.getElementById('list').classList.toggle('open');
}

function updateList() {
    let html = '';
    data.forEach((r, i) => {
        html += `
        <div class="room-card">
            <div class="room-card-header">
                <div class="room-card-title">üìç ${r.name.toUpperCase()}</div>
                <div style="color: rgba(255,255,255,0.5); font-size: 12px;">${r.time}</div>
            </div>
            <div class="room-card-details">
                <div class="room-card-detail">
                    <strong>Pareti</strong>
                    ${r.wallCount}
                </div>
                <div class="room-card-detail">
                    <strong>Finestre</strong>
                    ${r.windows}
                </div>
                <div class="room-card-detail">
                    <strong>Porte</strong>
                    ${r.doors}
                </div>
                <div class="room-card-detail">
                    <strong>Area</strong>
                    ${r.area.toFixed(1)} m¬≤
                </div>
            </div>
        </div>`;
    });
    document.getElementById('items').innerHTML = html || 
        '<p style="text-align:center;color:#666;padding:40px;">Nessuna stanza salvata</p>';
}

function generateFloorPlan() {
    if (data.length === 0) {
        alert('‚ùå Nessuna stanza da esportare!');
        return;
    }
    
    let txt = '‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó\n';
    txt += '‚ïë          PLANIMETRIA PROFESSIONALE - AR SCANNER PRO            ‚ïë\n';
    txt += '‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù\n\n';
    txt += `üìÖ Data: ${new Date().toLocaleDateString('it-IT')}\n`;
    txt += `üïê Ora: ${new Date().toLocaleTimeString('it-IT')}\n`;
    txt += `üìä Stanze totali: ${data.length}\n\n`;
    
    let totalArea = 0;
    let totalVolume = 0;
    
    data.forEach((r, i) => {
        totalArea += r.area;
        totalVolume += r.volume;
        
        txt += `\n${'‚ïê'.repeat(64)}\n`;
        txt += `üìç ${r.name.toUpperCase()} (Stanza ${i+1})\n`;
        txt += `${'‚îÄ'.repeat(64)}\n`;
        txt += `üèóÔ∏è  Struttura:\n`;
        txt += `   ‚Ä¢ Pareti: ${r.wallCount}\n`;
        txt += `   ‚Ä¢ Finestre: ${r.windows}\n`;
        txt += `   ‚Ä¢ Porte: ${r.doors}\n\n`;
        txt += `üìè Dimensioni:\n`;
        r.walls.forEach((w, j) => {
            txt += `   ‚Ä¢ Parete ${j+1}: ${w.toFixed(2)} m\n`;
        });
        txt += `\nüìê Calcoli:\n`;
        txt += `   ‚Ä¢ Area: ${r.area.toFixed(2)} m¬≤\n`;
        txt += `   ‚Ä¢ Volume: ${r.volume.toFixed(2)} m¬≥\n`;
        txt += `   ‚Ä¢ Altezza stimata: 2.80 m\n`;
        txt += `   ‚Ä¢ Perimetro: ${(r.walls.reduce((a,b) => a+b, 0)).toFixed(2)} m\n`;
    });
    
    txt += `\n${'‚ïê'.repeat(64)}\n`;
    txt += `üìä RIEPILOGO TOTALE\n`;
    txt += `${'‚ïê'.repeat(64)}\n`;
    txt += `‚Ä¢ Superficie totale: ${totalArea.toFixed(2)} m¬≤\n`;
    txt += `‚Ä¢ Volume totale: ${totalVolume.toFixed(2)} m¬≥\n`;
    txt += `‚Ä¢ Stanze rilevate: ${data.length}\n`;
    txt += `\n${'‚îÄ'.repeat(64)}\n`;
    txt += `Generato da AR Scanner Pro - Sistema di Rilevamento Intelligente\n`;
    txt += `Copyright ¬© 2026 - Tutti i diritti riservati\n`;
    txt += `${'‚îÄ'.repeat(64)}\n`;
    
    const blob = new Blob([txt], { type: 'text/plain;charset=utf-8' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `planimetria_${Date.now()}.txt`;
    a.click();
    
    alert('‚úÖ Planimetria professionale generata!\n\nüìä ' + data.length + ' stanze\nüìê ' + totalArea.toFixed(1) + ' m¬≤ totali');
}
</script>
</body>
</html>
